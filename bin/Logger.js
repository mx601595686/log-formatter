"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const is_in_browser_1 = require("is-in-browser");
const chalk = is_in_browser_1.default ? undefined : require.call(undefined, 'chalk'); //浏览器不进行样式格式化，同时防止webpack打包时引入chalk
/**
 * 消息模板的构造类
 *
 * @export
 * @class Logger
 */
class Logger extends Function {
    constructor() {
        super();
        /**
         * 日志类型
         */
        this._type = 0 /* log */;
        /**
         * 样式层数组
         */
        this._formatArray = [];
        // 第一层默认是当前时间
        this._formatArray.push({
            tag: "time",
            get text() {
                return is_in_browser_1.default ? `[${(new Date).toLocaleTimeString()}]` : chalk.gray(`[${(new Date).toLocaleTimeString()}]`);
            },
            template: []
        }, { template: [], tag: 'first' });
    }
    /**
     * 返回当前层
     */
    get _currentLayer() {
        return this._formatArray[this._formatArray.length - 1];
    }
    /**
     * 创建新的样式层。
     *
     * @private
     * @returns {FormatLayer} 返回新创建的层
     * @memberof Logger
     */
    _newLayer() {
        let layer = this._formatArray[1];
        if (layer.tag === 'first') {
            layer.tag = undefined;
        }
        else {
            layer = { template: [] };
            this._formatArray.push(layer);
        }
        return layer;
    }
    /**
     * 为当前层添加新的样式
     *
     * @private
     * @param {keyof _chalk.ChalkStyleMap} style chalk 样式的名称
     * @memberof Logger
     */
    _addStyle(style) {
        const layer = this._currentLayer;
        if (!is_in_browser_1.default) {
            layer.style = layer.style === undefined ? chalk[style] : layer.style[style];
        }
    }
    /**
     * 为当前层添加新的样式模板
     *
     * @private
     * @param {(arg: string) => string} template 样式模板
     * @memberof Logger
     */
    _addTemplate(template) {
        const layer = this._currentLayer;
        layer.template.push(template);
    }
    format(...text) {
        const result = [];
        for (let i = 0, j = 0; i < text.length; j++) {
            let txt;
            let style;
            let template;
            if (j < this._formatArray.length) {
                if (this._formatArray[j].skip === true)
                    continue;
                txt = this._formatArray[j].text !== undefined ? this._formatArray[j].text : text[i++];
                style = this._formatArray[j].style;
                template = this._formatArray[j].template;
            }
            else {
                txt = text[i++];
                style = this._formatArray[this._formatArray.length - 1].style;
                template = this._formatArray[this._formatArray.length - 1].template;
            }
            switch (Object.prototype.toString.call(txt)) {
                case '[object Error]':
                    txt = txt.message + ' -> ' + txt.stack;
                    break;
                default:
                    if (typeof txt === 'object')
                        txt = JSON.stringify(txt);
                    break;
            }
            if (style !== undefined) {
                txt = style(txt);
            }
            if (template !== undefined) {
                txt = template.reduce((pre, tmp) => tmp(pre), txt);
            }
            result.push(txt);
        }
        return result;
    }
    /**
     * 将格式化后的内容打印到控制台
     *
     * @param {...any[]} text 要被格式化的内容
     * @memberof Logger
     */
    log(...text) {
        switch (this._type) {
            case 0 /* log */:
                console.log(...this.format(...text));
                break;
            case 1 /* warning */:
                console.warn(...this.format(...text));
                break;
            case 2 /* error */:
                console.error(...this.format(...text));
                break;
            default:
                throw new Error('没有对应的日志输出类型：' + this._type);
        }
    }
    /**
     * 包装当前对象
     *
     * @returns {LoggerPublicProperties}
     * @memberof Logger
     */
    toProxy() {
        return new Proxy(this, {
            apply(target, thisArg, argumentsList) {
                target.log(...argumentsList);
            },
            get(target, property, receiver) {
                switch (property) {
                    case 'format':
                        return target.format.bind(target);
                    case 'line':
                        return (char = '-', length = 100) => console.log('\r\n', char.repeat(length), '\r\n');
                    case 'lineWithText'://双线夹文字
                        return (text, char = '-', length = 100) => {
                            let whiteSpace = 0;
                            if (text.length < length) {
                                whiteSpace = (length - text.length) / 2;
                            }
                            console.log('\r\n', char.repeat(length), '\r\n', ' '.repeat(whiteSpace), text, '\r\n', char.repeat(length), '\r\n');
                        };
                    case 'warn':
                        target._type = 1 /* warning */;
                        return receiver.yellow;
                    case 'error':
                        target._type = 2 /* error */;
                        return receiver.red;
                    case 'noTime':
                        target._formatArray[0].skip = true;
                        return receiver;
                    case 'text':
                    case 'title':
                        target._newLayer();
                        return receiver;
                    case 'linefeed':
                        target._newLayer().text = '\r\n';
                        return receiver;
                    case 'content':
                        return receiver.linefeed.text;
                    case 'square':
                        target._addTemplate((arg) => `[${arg}]`);
                        return receiver;
                    case 'location':
                        return receiver.text.square;
                    case 'round':
                        target._addTemplate((arg) => `(${arg})`);
                        return receiver;
                    case 'mustache':
                        target._addTemplate((arg) => `{${arg}}`);
                        return receiver;
                    default://chalk 样式
                        target._addStyle(property);
                        return receiver;
                }
            }
        });
    }
}
exports.Logger = Logger;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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RyxLQUFLLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQzt3QkFDekMsTUFBTSxDQUFDLFFBQVEsQ0FBQztvQkFFcEIsUUFBWSxVQUFVO3dCQUNsQixNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO3dCQUMzQixNQUFNLENBQUMsUUFBUSxDQUFDO2dCQUN4QixDQUFDO1lBQ0wsQ0FBQztTQUNKLENBQVEsQ0FBQztJQUNkLENBQUM7Q0FDSjtBQTdORCx3QkE2TkMiLCJmaWxlIjoiTG9nZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgX2NoYWxrIGZyb20gJ2NoYWxrJztcclxuaW1wb3J0IGlzQnJvd3NlciBmcm9tICdpcy1pbi1icm93c2VyJztcclxuY29uc3QgY2hhbGs6IHR5cGVvZiBfY2hhbGsgPSBpc0Jyb3dzZXIgPyB1bmRlZmluZWQgOiByZXF1aXJlLmNhbGwodW5kZWZpbmVkLCAnY2hhbGsnKTsgIC8v5rWP6KeI5Zmo5LiN6L+b6KGM5qC35byP5qC85byP5YyW77yM5ZCM5pe26Ziy5q2id2VicGFja+aJk+WMheaXtuW8leWFpWNoYWxrXHJcblxyXG5pbXBvcnQgeyBMb2dUeXBlIH0gZnJvbSAnLi9Mb2dUeXBlJztcclxuaW1wb3J0IHsgTG9nZ2VyUHVibGljUHJvcGVydGllcyB9IGZyb20gJy4vTG9nZ2VyUHVibGljUHJvcGVydGllcyc7XHJcbmltcG9ydCB7IEZvcm1hdExheWVyIH0gZnJvbSAnLi9Gb3JtYXRMYXllcic7XHJcblxyXG4vKipcclxuICog5raI5oGv5qih5p2/55qE5p6E6YCg57G7XHJcbiAqIFxyXG4gKiBAZXhwb3J0XHJcbiAqIEBjbGFzcyBMb2dnZXJcclxuICovXHJcbmV4cG9ydCBjbGFzcyBMb2dnZXIgZXh0ZW5kcyBGdW5jdGlvbiB7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDml6Xlv5fnsbvlnotcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfdHlwZSA9IExvZ1R5cGUubG9nO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog5qC35byP5bGC5pWw57uEICAgIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9mb3JtYXRBcnJheTogRm9ybWF0TGF5ZXJbXSA9IFtdO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcblxyXG4gICAgICAgIC8vIOesrOS4gOWxgum7mOiupOaYr+W9k+WJjeaXtumXtFxyXG4gICAgICAgIHRoaXMuX2Zvcm1hdEFycmF5LnB1c2goe1xyXG4gICAgICAgICAgICB0YWc6IFwidGltZVwiLFxyXG4gICAgICAgICAgICBnZXQgdGV4dCgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBpc0Jyb3dzZXIgPyBgWyR7KG5ldyBEYXRlKS50b0xvY2FsZVRpbWVTdHJpbmcoKX1dYCA6IGNoYWxrLmdyYXkoYFskeyhuZXcgRGF0ZSkudG9Mb2NhbGVUaW1lU3RyaW5nKCl9XWApO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZTogW11cclxuICAgICAgICB9LCB7IHRlbXBsYXRlOiBbXSwgdGFnOiAnZmlyc3QnIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6L+U5Zue5b2T5YmN5bGCXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgZ2V0IF9jdXJyZW50TGF5ZXIoKTogRm9ybWF0TGF5ZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9mb3JtYXRBcnJheVt0aGlzLl9mb3JtYXRBcnJheS5sZW5ndGggLSAxXTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIm+W7uuaWsOeahOagt+W8j+WxguOAglxyXG4gICAgICogXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQHJldHVybnMge0Zvcm1hdExheWVyfSDov5Tlm57mlrDliJvlu7rnmoTlsYJcclxuICAgICAqIEBtZW1iZXJvZiBMb2dnZXJcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBfbmV3TGF5ZXIoKTogRm9ybWF0TGF5ZXIge1xyXG4gICAgICAgIGxldCBsYXllciA9IHRoaXMuX2Zvcm1hdEFycmF5WzFdO1xyXG4gICAgICAgIGlmIChsYXllci50YWcgPT09ICdmaXJzdCcpIHtcclxuICAgICAgICAgICAgbGF5ZXIudGFnID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxheWVyID0geyB0ZW1wbGF0ZTogW10gfTtcclxuICAgICAgICAgICAgdGhpcy5fZm9ybWF0QXJyYXkucHVzaChsYXllcik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBsYXllcjtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOS4uuW9k+WJjeWxgua3u+WKoOaWsOeahOagt+W8j1xyXG4gICAgICogXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQHBhcmFtIHtrZXlvZiBfY2hhbGsuQ2hhbGtTdHlsZU1hcH0gc3R5bGUgY2hhbGsg5qC35byP55qE5ZCN56ewXHJcbiAgICAgKiBAbWVtYmVyb2YgTG9nZ2VyXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2FkZFN0eWxlKHN0eWxlOiBrZXlvZiBfY2hhbGsuQ2hhbGtTdHlsZU1hcCkge1xyXG4gICAgICAgIGNvbnN0IGxheWVyID0gdGhpcy5fY3VycmVudExheWVyO1xyXG4gICAgICAgIGlmICghaXNCcm93c2VyKSB7ICAgLy/mtY/op4jlmajmsqHmnInmoLflvI9cclxuICAgICAgICAgICAgbGF5ZXIuc3R5bGUgPSBsYXllci5zdHlsZSA9PT0gdW5kZWZpbmVkID8gY2hhbGtbc3R5bGVdIDogbGF5ZXIuc3R5bGVbc3R5bGVdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOS4uuW9k+WJjeWxgua3u+WKoOaWsOeahOagt+W8j+aooeadv1xyXG4gICAgICogXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQHBhcmFtIHsoYXJnOiBzdHJpbmcpID0+IHN0cmluZ30gdGVtcGxhdGUg5qC35byP5qih5p2/XHJcbiAgICAgKiBAbWVtYmVyb2YgTG9nZ2VyXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2FkZFRlbXBsYXRlKHRlbXBsYXRlOiAoYXJnOiBzdHJpbmcpID0+IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGxheWVyID0gdGhpcy5fY3VycmVudExheWVyO1xyXG4gICAgICAgIGxheWVyLnRlbXBsYXRlLnB1c2godGVtcGxhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGZvcm1hdCguLi50ZXh0OiBhbnlbXSk6IGFueVtdIHtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGogPSAwOyBpIDwgdGV4dC5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICBsZXQgdHh0OiBzdHJpbmc7XHJcbiAgICAgICAgICAgIGxldCBzdHlsZTogX2NoYWxrLkNoYWxrQ2hhaW4gfCB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIGxldCB0ZW1wbGF0ZTogKChhcmc6IHN0cmluZykgPT4gc3RyaW5nKVtdO1xyXG5cclxuICAgICAgICAgICAgaWYgKGogPCB0aGlzLl9mb3JtYXRBcnJheS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9mb3JtYXRBcnJheVtqXS5za2lwID09PSB0cnVlKSBjb250aW51ZTtcclxuXHJcbiAgICAgICAgICAgICAgICB0eHQgPSB0aGlzLl9mb3JtYXRBcnJheVtqXS50ZXh0ICE9PSB1bmRlZmluZWQgPyB0aGlzLl9mb3JtYXRBcnJheVtqXS50ZXh0IDogdGV4dFtpKytdO1xyXG4gICAgICAgICAgICAgICAgc3R5bGUgPSB0aGlzLl9mb3JtYXRBcnJheVtqXS5zdHlsZTtcclxuICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gdGhpcy5fZm9ybWF0QXJyYXlbal0udGVtcGxhdGU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7ICAgLy/liankuIvnmoTlj4LmlbDlhajpg6jkvb/nlKjmnIDlkI7kuIDnp43moLflvI/ov5vooYzmoLzlvI/ljJZcclxuICAgICAgICAgICAgICAgIHR4dCA9IHRleHRbaSsrXTtcclxuICAgICAgICAgICAgICAgIHN0eWxlID0gdGhpcy5fZm9ybWF0QXJyYXlbdGhpcy5fZm9ybWF0QXJyYXkubGVuZ3RoIC0gMV0uc3R5bGU7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IHRoaXMuX2Zvcm1hdEFycmF5W3RoaXMuX2Zvcm1hdEFycmF5Lmxlbmd0aCAtIDFdLnRlbXBsYXRlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBzd2l0Y2ggKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh0eHQpKSB7ICAvL+WvueeJueWumuexu+Wei+eahOWvueixoei/m+ihjOeJueWumui9rOaNolxyXG4gICAgICAgICAgICAgICAgY2FzZSAnW29iamVjdCBFcnJvcl0nOlxyXG4gICAgICAgICAgICAgICAgICAgIHR4dCA9ICg8YW55PnR4dCkubWVzc2FnZSArICcgLT4gJyArICg8YW55PnR4dCkuc3RhY2s7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR4dCA9PT0gJ29iamVjdCcpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR4dCA9IEpTT04uc3RyaW5naWZ5KHR4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChzdHlsZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICB0eHQgPSBzdHlsZSh0eHQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGVtcGxhdGUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdHh0ID0gdGVtcGxhdGUucmVkdWNlKChwcmUsIHRtcCkgPT4gdG1wKHByZSksIHR4dCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHR4dCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5bCG5qC85byP5YyW5ZCO55qE5YaF5a655omT5Y2w5Yiw5o6n5Yi25Y+wXHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSB7Li4uYW55W119IHRleHQg6KaB6KKr5qC85byP5YyW55qE5YaF5a65XHJcbiAgICAgKiBAbWVtYmVyb2YgTG9nZ2VyXHJcbiAgICAgKi9cclxuICAgIGxvZyguLi50ZXh0OiBhbnlbXSk6IHZvaWQge1xyXG4gICAgICAgIHN3aXRjaCAodGhpcy5fdHlwZSkge1xyXG4gICAgICAgICAgICBjYXNlIExvZ1R5cGUubG9nOlxyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coLi4udGhpcy5mb3JtYXQoLi4udGV4dCkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICBjYXNlIExvZ1R5cGUud2FybmluZzpcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybiguLi50aGlzLmZvcm1hdCguLi50ZXh0KSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgICAgIGNhc2UgTG9nVHlwZS5lcnJvcjpcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoLi4udGhpcy5mb3JtYXQoLi4udGV4dCkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfmsqHmnInlr7nlupTnmoTml6Xlv5fovpPlh7rnsbvlnovvvJonICsgdGhpcy5fdHlwZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5YyF6KOF5b2T5YmN5a+56LGhXHJcbiAgICAgKiBcclxuICAgICAqIEByZXR1cm5zIHtMb2dnZXJQdWJsaWNQcm9wZXJ0aWVzfSBcclxuICAgICAqIEBtZW1iZXJvZiBMb2dnZXJcclxuICAgICAqL1xyXG4gICAgdG9Qcm94eSgpOiBMb2dnZXJQdWJsaWNQcm9wZXJ0aWVzIHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb3h5KHRoaXMsIHtcclxuICAgICAgICAgICAgYXBwbHkodGFyZ2V0LCB0aGlzQXJnLCBhcmd1bWVudHNMaXN0KSB7XHJcbiAgICAgICAgICAgICAgICB0YXJnZXQubG9nKC4uLmFyZ3VtZW50c0xpc3QpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBnZXQodGFyZ2V0LCBwcm9wZXJ0eToga2V5b2YgTG9nZ2VyUHVibGljUHJvcGVydGllcywgcmVjZWl2ZXIpIHtcclxuICAgICAgICAgICAgICAgIHN3aXRjaCAocHJvcGVydHkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdmb3JtYXQnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0LmZvcm1hdC5iaW5kKHRhcmdldCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2xpbmUnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGNoYXI6IHN0cmluZyA9ICctJywgbGVuZ3RoOiBudW1iZXIgPSAxMDApID0+IGNvbnNvbGUubG9nKCdcXHJcXG4nLCBjaGFyLnJlcGVhdChsZW5ndGgpLCAnXFxyXFxuJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2xpbmVXaXRoVGV4dCc6ICAgIC8v5Y+M57q/5aS55paH5a2XXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAodGV4dDogYW55LCBjaGFyOiBzdHJpbmcgPSAnLScsIGxlbmd0aDogbnVtYmVyID0gMTAwKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgd2hpdGVTcGFjZSA9IDA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGV4dC5sZW5ndGggPCBsZW5ndGgpIHsgICAgLy/lsYXkuK3mmL7npLpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGl0ZVNwYWNlID0gKGxlbmd0aCAtIHRleHQubGVuZ3RoKSAvIDI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1xcclxcbicsIGNoYXIucmVwZWF0KGxlbmd0aCksICdcXHJcXG4nLCAnICcucmVwZWF0KHdoaXRlU3BhY2UpLCB0ZXh0LCAnXFxyXFxuJywgY2hhci5yZXBlYXQobGVuZ3RoKSwgJ1xcclxcbicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3dhcm4nOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuX3R5cGUgPSBMb2dUeXBlLndhcm5pbmc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWNlaXZlci55ZWxsb3c7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Vycm9yJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Ll90eXBlID0gTG9nVHlwZS5lcnJvcjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY2VpdmVyLnJlZDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbm9UaW1lJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Ll9mb3JtYXRBcnJheVswXS5za2lwID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY2VpdmVyO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICd0aXRsZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5fbmV3TGF5ZXIoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY2VpdmVyO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdsaW5lZmVlZCc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5fbmV3TGF5ZXIoKS50ZXh0ID0gJ1xcclxcbic7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWNlaXZlcjtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnY29udGVudCc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWNlaXZlci5saW5lZmVlZC50ZXh0O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdzcXVhcmUnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuX2FkZFRlbXBsYXRlKChhcmcpID0+IGBbJHthcmd9XWApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjZWl2ZXI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2xvY2F0aW9uJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY2VpdmVyLnRleHQuc3F1YXJlO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdyb3VuZCc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5fYWRkVGVtcGxhdGUoKGFyZykgPT4gYCgke2FyZ30pYCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWNlaXZlcjtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbXVzdGFjaGUnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuX2FkZFRlbXBsYXRlKChhcmcpID0+IGB7JHthcmd9fWApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjZWl2ZXI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6ICAgIC8vY2hhbGsg5qC35byPXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5fYWRkU3R5bGUocHJvcGVydHkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjZWl2ZXI7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KSBhcyBhbnk7XHJcbiAgICB9XHJcbn0iXX0=
