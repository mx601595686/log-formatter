"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const is_in_browser_1 = require("is-in-browser");
const chalk = is_in_browser_1.default ? undefined : require.call(undefined, 'chalk'); //浏览器不进行样式格式化，同时防止webpack打包时引入chalk
/**
 * 消息模板的构造类
 *
 * @export
 * @class Logger
 */
class Logger extends Function {
    constructor() {
        super();
        /**
         * 日志类型
         */
        this._type = 0 /* log */;
        /**
         * 样式层数组
         */
        this._formatArray = [];
        // 第一层默认是时间
        this._formatArray.push({
            tag: "time",
            get text() {
                return is_in_browser_1.default ? `[${(new Date).toLocaleTimeString()}]` : chalk.gray(`[${(new Date).toLocaleTimeString()}]`);
            },
            template: []
        });
    }
    /**
     * 创建新的样式层。
     *
     * @private
     * @returns {FormatLayer} 返回新创建的层
     * @memberof Logger
     */
    _newLayer() {
        const layer = { template: [] };
        this._formatArray.push(layer);
        return layer;
    }
    /**
     * 返回当前层
     *
     * @private
     * @memberof Logger
     */
    _currentLayer() {
        let layer = this._formatArray[this._formatArray.length - 1];
        if (layer === undefined || layer.tag === 'time') {
            layer = this._newLayer();
            layer.tag = 'first'; //第一层
        }
        return layer;
    }
    /**
     * 为当前层添加新的样式
     *
     * @private
     * @param {keyof _chalk.ChalkStyleMap} style chalk 样式的名称
     * @memberof Logger
     */
    _addStyle(style) {
        const layer = this._currentLayer();
        if (!is_in_browser_1.default) {
            layer.style = layer.style === undefined ? chalk[style] : layer.style[style];
        }
    }
    /**
     * 为当前层添加新的样式模板
     *
     * @private
     * @param {(arg: string) => string} template 样式模板
     * @memberof Logger
     */
    _addTemplate(template) {
        const layer = this._currentLayer();
        layer.template.push(template);
    }
    format(...text) {
        const result = [];
        for (let i = 0, j = 0; i < text.length; j++) {
            let txt;
            let style;
            let template;
            if (j < this._formatArray.length) {
                txt = this._formatArray[j].text !== undefined ? this._formatArray[j].text : text[i++];
                style = this._formatArray[j].style;
                template = this._formatArray[j].template;
            }
            else {
                txt = text[i++];
                style = this._formatArray[this._formatArray.length - 1].style;
                template = this._formatArray[this._formatArray.length - 1].template;
            }
            switch (Object.prototype.toString.call(txt)) {
                case '[object Error]':
                    txt = txt.stack;
                    break;
                default:
                    if (typeof txt === 'object')
                        txt = JSON.stringify(txt);
                    break;
            }
            if (style !== undefined) {
                txt = style(txt);
            }
            if (template !== undefined) {
                txt = template.reduce((pre, tmp) => tmp(pre), txt);
            }
            result.push(txt);
        }
        return result;
    }
    /**
     * 将格式化后的内容打印到控制台
     *
     * @param {...any[]} text 要被格式化的内容
     * @memberof Logger
     */
    log(...text) {
        switch (this._type) {
            case 0 /* log */:
                console.log(...this.format(...text));
                break;
            case 1 /* warning */:
                console.warn(...this.format(...text));
                break;
            case 2 /* error */:
                console.error(...this.format(...text));
                break;
            default:
                throw new Error('没有对应的日志输出类型：' + this._type);
        }
    }
    /**
     * 包装当前对象
     *
     * @returns {LoggerPublicProperties}
     * @memberof Logger
     */
    toProxy() {
        return new Proxy(this, {
            apply(target, thisArg, argumentsList) {
                target.log(...argumentsList);
            },
            get(target, property, receiver) {
                switch (property) {
                    case 'format':
                        return target.format.bind(target);
                    case 'line':
                        return (char = '-', length = 100) => console.log('\r\n', char.repeat(length), '\r\n');
                    case 'lineWithText'://双线夹文字
                        return (text, char = '-', length = 100) => {
                            let whiteSpace = 0;
                            if (text.length < length) {
                                whiteSpace = (length - text.length) / 2;
                            }
                            console.log('\r\n', char.repeat(length), '\r\n', ' '.repeat(whiteSpace), text, '\r\n', char.repeat(length), '\r\n');
                        };
                    case 'warn':
                        target._type = 1 /* warning */;
                        return receiver.yellow;
                    case 'error':
                        target._type = 2 /* error */;
                        return receiver.red;
                    case 'noTime':
                        if (target._formatArray[0].tag === 'time')
                            target._formatArray.shift();
                        return receiver;
                    case 'text':
                    case 'title':
                        target._newLayer();
                        return receiver;
                    case 'linefeed':
                        target._newLayer().text = '\r\n';
                        return receiver;
                    case 'content':
                        return receiver.linefeed.text;
                    case 'square':
                    case 'location':
                        target._addTemplate((arg) => `[${arg}]`);
                        return receiver;
                    case 'round':
                        target._addTemplate((arg) => `(${arg})`);
                        return receiver;
                    case 'mustache':
                        target._addTemplate((arg) => `{${arg}}`);
                        return receiver;
                    default://chalk 样式
                        target._addStyle(property);
                        return receiver;
                }
            }
        });
    }
}
exports.Logger = Logger;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxRQUFRLENBQUM7Z0JBQ3hCLENBQUM7WUFDTCxDQUFDO1NBQ0osQ0FBUSxDQUFDO0lBQ2QsQ0FBQztDQUNKO0FBL05ELHdCQStOQyIsImZpbGUiOiJMb2dnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBfY2hhbGsgZnJvbSAnY2hhbGsnO1xyXG5pbXBvcnQgaXNCcm93c2VyIGZyb20gJ2lzLWluLWJyb3dzZXInO1xyXG5jb25zdCBjaGFsazogdHlwZW9mIF9jaGFsayA9IGlzQnJvd3NlciA/IHVuZGVmaW5lZCA6IHJlcXVpcmUuY2FsbCh1bmRlZmluZWQsICdjaGFsaycpOyAgLy/mtY/op4jlmajkuI3ov5vooYzmoLflvI/moLzlvI/ljJbvvIzlkIzml7bpmLLmraJ3ZWJwYWNr5omT5YyF5pe25byV5YWlY2hhbGtcclxuXHJcbmltcG9ydCB7IExvZ1R5cGUgfSBmcm9tICcuL0xvZ1R5cGUnO1xyXG5pbXBvcnQgeyBMb2dnZXJQdWJsaWNQcm9wZXJ0aWVzIH0gZnJvbSAnLi9Mb2dnZXJQdWJsaWNQcm9wZXJ0aWVzJztcclxuaW1wb3J0IHsgRm9ybWF0TGF5ZXIgfSBmcm9tICcuL0Zvcm1hdExheWVyJztcclxuXHJcbi8qKlxyXG4gKiDmtojmga/mqKHmnb/nmoTmnoTpgKDnsbtcclxuICogXHJcbiAqIEBleHBvcnRcclxuICogQGNsYXNzIExvZ2dlclxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIExvZ2dlciBleHRlbmRzIEZ1bmN0aW9uIHtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOaXpeW/l+exu+Wei1xyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF90eXBlID0gTG9nVHlwZS5sb2c7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmoLflvI/lsYLmlbDnu4QgICAgXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2Zvcm1hdEFycmF5OiBGb3JtYXRMYXllcltdID0gW107XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuXHJcbiAgICAgICAgLy8g56ys5LiA5bGC6buY6K6k5piv5pe26Ze0XHJcbiAgICAgICAgdGhpcy5fZm9ybWF0QXJyYXkucHVzaCh7XHJcbiAgICAgICAgICAgIHRhZzogXCJ0aW1lXCIsXHJcbiAgICAgICAgICAgIGdldCB0ZXh0KCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGlzQnJvd3NlciA/IGBbJHsobmV3IERhdGUpLnRvTG9jYWxlVGltZVN0cmluZygpfV1gIDogY2hhbGsuZ3JheShgWyR7KG5ldyBEYXRlKS50b0xvY2FsZVRpbWVTdHJpbmcoKX1dYCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHRlbXBsYXRlOiBbXVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yib5bu65paw55qE5qC35byP5bGC44CCXHJcbiAgICAgKiBcclxuICAgICAqIEBwcml2YXRlXHJcbiAgICAgKiBAcmV0dXJucyB7Rm9ybWF0TGF5ZXJ9IOi/lOWbnuaWsOWIm+W7uueahOWxglxyXG4gICAgICogQG1lbWJlcm9mIExvZ2dlclxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9uZXdMYXllcigpOiBGb3JtYXRMYXllciB7XHJcbiAgICAgICAgY29uc3QgbGF5ZXIgPSB7IHRlbXBsYXRlOiBbXSB9O1xyXG4gICAgICAgIHRoaXMuX2Zvcm1hdEFycmF5LnB1c2gobGF5ZXIpO1xyXG4gICAgICAgIHJldHVybiBsYXllcjtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOi/lOWbnuW9k+WJjeWxglxyXG4gICAgICogXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQG1lbWJlcm9mIExvZ2dlclxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIF9jdXJyZW50TGF5ZXIoKTogRm9ybWF0TGF5ZXIge1xyXG4gICAgICAgIGxldCBsYXllciA9IHRoaXMuX2Zvcm1hdEFycmF5W3RoaXMuX2Zvcm1hdEFycmF5Lmxlbmd0aCAtIDFdO1xyXG4gICAgICAgIGlmIChsYXllciA9PT0gdW5kZWZpbmVkIHx8IGxheWVyLnRhZyA9PT0gJ3RpbWUnKSB7XHJcbiAgICAgICAgICAgIGxheWVyID0gdGhpcy5fbmV3TGF5ZXIoKTtcclxuICAgICAgICAgICAgbGF5ZXIudGFnID0gJ2ZpcnN0JzsgICAgLy/nrKzkuIDlsYJcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBsYXllcjtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOS4uuW9k+WJjeWxgua3u+WKoOaWsOeahOagt+W8j1xyXG4gICAgICogXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQHBhcmFtIHtrZXlvZiBfY2hhbGsuQ2hhbGtTdHlsZU1hcH0gc3R5bGUgY2hhbGsg5qC35byP55qE5ZCN56ewXHJcbiAgICAgKiBAbWVtYmVyb2YgTG9nZ2VyXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2FkZFN0eWxlKHN0eWxlOiBrZXlvZiBfY2hhbGsuQ2hhbGtTdHlsZU1hcCkge1xyXG4gICAgICAgIGNvbnN0IGxheWVyID0gdGhpcy5fY3VycmVudExheWVyKCk7XHJcblxyXG4gICAgICAgIGlmICghaXNCcm93c2VyKSB7ICAgLy/mtY/op4jlmajmsqHmnInmoLflvI9cclxuICAgICAgICAgICAgbGF5ZXIuc3R5bGUgPSBsYXllci5zdHlsZSA9PT0gdW5kZWZpbmVkID8gY2hhbGtbc3R5bGVdIDogbGF5ZXIuc3R5bGVbc3R5bGVdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOS4uuW9k+WJjeWxgua3u+WKoOaWsOeahOagt+W8j+aooeadv1xyXG4gICAgICogXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICogQHBhcmFtIHsoYXJnOiBzdHJpbmcpID0+IHN0cmluZ30gdGVtcGxhdGUg5qC35byP5qih5p2/XHJcbiAgICAgKiBAbWVtYmVyb2YgTG9nZ2VyXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgX2FkZFRlbXBsYXRlKHRlbXBsYXRlOiAoYXJnOiBzdHJpbmcpID0+IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGxheWVyID0gdGhpcy5fY3VycmVudExheWVyKCk7XHJcbiAgICAgICAgbGF5ZXIudGVtcGxhdGUucHVzaCh0ZW1wbGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgZm9ybWF0KC4uLnRleHQ6IGFueVtdKTogYW55W10ge1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMCwgaiA9IDA7IGkgPCB0ZXh0Lmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgIGxldCB0eHQ6IHN0cmluZztcclxuICAgICAgICAgICAgbGV0IHN0eWxlOiBfY2hhbGsuQ2hhbGtDaGFpbiB8IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgbGV0IHRlbXBsYXRlOiAoKGFyZzogc3RyaW5nKSA9PiBzdHJpbmcpW107XHJcblxyXG4gICAgICAgICAgICBpZiAoaiA8IHRoaXMuX2Zvcm1hdEFycmF5Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdHh0ID0gdGhpcy5fZm9ybWF0QXJyYXlbal0udGV4dCAhPT0gdW5kZWZpbmVkID8gdGhpcy5fZm9ybWF0QXJyYXlbal0udGV4dCA6IHRleHRbaSsrXTtcclxuICAgICAgICAgICAgICAgIHN0eWxlID0gdGhpcy5fZm9ybWF0QXJyYXlbal0uc3R5bGU7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IHRoaXMuX2Zvcm1hdEFycmF5W2pdLnRlbXBsYXRlO1xyXG4gICAgICAgICAgICB9IGVsc2UgeyAgIC8v5Ymp5LiL55qE5Y+C5pWw5YWo6YOo5L2/55So5pyA5ZCO5LiA56eN5qC35byP6L+b6KGM5qC85byP5YyWXHJcbiAgICAgICAgICAgICAgICB0eHQgPSB0ZXh0W2krK107XHJcbiAgICAgICAgICAgICAgICBzdHlsZSA9IHRoaXMuX2Zvcm1hdEFycmF5W3RoaXMuX2Zvcm1hdEFycmF5Lmxlbmd0aCAtIDFdLnN0eWxlO1xyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGUgPSB0aGlzLl9mb3JtYXRBcnJheVt0aGlzLl9mb3JtYXRBcnJheS5sZW5ndGggLSAxXS50ZW1wbGF0ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgc3dpdGNoIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodHh0KSkgeyAgLy/lr7nnibnlrprnsbvlnovnmoTlr7nosaHov5vooYznibnlrprovazmjaJcclxuICAgICAgICAgICAgICAgIGNhc2UgJ1tvYmplY3QgRXJyb3JdJzpcclxuICAgICAgICAgICAgICAgICAgICB0eHQgPSAoPGFueT50eHQpLnN0YWNrO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eHQgPT09ICdvYmplY3QnKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eHQgPSBKU09OLnN0cmluZ2lmeSh0eHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoc3R5bGUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdHh0ID0gc3R5bGUodHh0KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHRlbXBsYXRlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHR4dCA9IHRlbXBsYXRlLnJlZHVjZSgocHJlLCB0bXApID0+IHRtcChwcmUpLCB0eHQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh0eHQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWwhuagvOW8j+WMluWQjueahOWGheWuueaJk+WNsOWIsOaOp+WItuWPsFxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0gey4uLmFueVtdfSB0ZXh0IOimgeiiq+agvOW8j+WMlueahOWGheWuuVxyXG4gICAgICogQG1lbWJlcm9mIExvZ2dlclxyXG4gICAgICovXHJcbiAgICBsb2coLi4udGV4dDogYW55W10pOiB2b2lkIHtcclxuICAgICAgICBzd2l0Y2ggKHRoaXMuX3R5cGUpIHtcclxuICAgICAgICAgICAgY2FzZSBMb2dUeXBlLmxvZzpcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKC4uLnRoaXMuZm9ybWF0KC4uLnRleHQpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgY2FzZSBMb2dUeXBlLndhcm5pbmc6XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oLi4udGhpcy5mb3JtYXQoLi4udGV4dCkpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcblxyXG4gICAgICAgICAgICBjYXNlIExvZ1R5cGUuZXJyb3I6XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKC4uLnRoaXMuZm9ybWF0KC4uLnRleHQpKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcign5rKh5pyJ5a+55bqU55qE5pel5b+X6L6T5Ye657G75Z6L77yaJyArIHRoaXMuX3R5cGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWMheijheW9k+WJjeWvueixoVxyXG4gICAgICogXHJcbiAgICAgKiBAcmV0dXJucyB7TG9nZ2VyUHVibGljUHJvcGVydGllc30gXHJcbiAgICAgKiBAbWVtYmVyb2YgTG9nZ2VyXHJcbiAgICAgKi9cclxuICAgIHRvUHJveHkoKTogTG9nZ2VyUHVibGljUHJvcGVydGllcyB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm94eSh0aGlzLCB7XHJcbiAgICAgICAgICAgIGFwcGx5KHRhcmdldCwgdGhpc0FyZywgYXJndW1lbnRzTGlzdCkge1xyXG4gICAgICAgICAgICAgICAgdGFyZ2V0LmxvZyguLi5hcmd1bWVudHNMaXN0KTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0KHRhcmdldCwgcHJvcGVydHk6IGtleW9mIExvZ2dlclB1YmxpY1Byb3BlcnRpZXMsIHJlY2VpdmVyKSB7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnZm9ybWF0JzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldC5mb3JtYXQuYmluZCh0YXJnZXQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdsaW5lJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChjaGFyOiBzdHJpbmcgPSAnLScsIGxlbmd0aDogbnVtYmVyID0gMTAwKSA9PiBjb25zb2xlLmxvZygnXFxyXFxuJywgY2hhci5yZXBlYXQobGVuZ3RoKSwgJ1xcclxcbicpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdsaW5lV2l0aFRleHQnOiAgICAvL+WPjOe6v+WkueaWh+Wtl1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHRleHQ6IGFueSwgY2hhcjogc3RyaW5nID0gJy0nLCBsZW5ndGg6IG51bWJlciA9IDEwMCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHdoaXRlU3BhY2UgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRleHQubGVuZ3RoIDwgbGVuZ3RoKSB7ICAgIC8v5bGF5Lit5pi+56S6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpdGVTcGFjZSA9IChsZW5ndGggLSB0ZXh0Lmxlbmd0aCkgLyAyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdcXHJcXG4nLCBjaGFyLnJlcGVhdChsZW5ndGgpLCAnXFxyXFxuJywgJyAnLnJlcGVhdCh3aGl0ZVNwYWNlKSwgdGV4dCwgJ1xcclxcbicsIGNoYXIucmVwZWF0KGxlbmd0aCksICdcXHJcXG4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICd3YXJuJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Ll90eXBlID0gTG9nVHlwZS53YXJuaW5nO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjZWl2ZXIueWVsbG93O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdlcnJvcic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5fdHlwZSA9IExvZ1R5cGUuZXJyb3I7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWNlaXZlci5yZWQ7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ25vVGltZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQuX2Zvcm1hdEFycmF5WzBdLnRhZyA9PT0gJ3RpbWUnKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Ll9mb3JtYXRBcnJheS5zaGlmdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjZWl2ZXI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RpdGxlJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Ll9uZXdMYXllcigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjZWl2ZXI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ2xpbmVmZWVkJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Ll9uZXdMYXllcigpLnRleHQgPSAnXFxyXFxuJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY2VpdmVyO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdjb250ZW50JzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY2VpdmVyLmxpbmVmZWVkLnRleHQ7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NxdWFyZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbG9jYXRpb24nOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuX2FkZFRlbXBsYXRlKChhcmcpID0+IGBbJHthcmd9XWApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjZWl2ZXI7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JvdW5kJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Ll9hZGRUZW1wbGF0ZSgoYXJnKSA9PiBgKCR7YXJnfSlgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY2VpdmVyO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjYXNlICdtdXN0YWNoZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5fYWRkVGVtcGxhdGUoKGFyZykgPT4gYHske2FyZ319YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWNlaXZlcjtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogICAgLy9jaGFsayDmoLflvI9cclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Ll9hZGRTdHlsZShwcm9wZXJ0eSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWNlaXZlcjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pIGFzIGFueTtcclxuICAgIH1cclxufSJdfQ==
